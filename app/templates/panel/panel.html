{% extends 'base_panel.html' %}
{% block title %}Visio-Shapes Panel{% endblock %}

{% block content %}

<div class="panel-filter">
  <input type="text" id="search" placeholder="Suchen…" autocomplete="off" spellcheck="false">
  <select id="category-filter">
    <option value="">Alle</option>
  </select>
</div>

<div class="panel-shapes" id="panel-shapes">
  <div class="panel-loading">Shapes werden geladen…</div>
</div>

{% endblock %}

{% block scripts %}
<script>
  let allShapes = [];

  function escHtml(str) {
    return String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function renderShapes(shapes) {
    const container = document.getElementById('panel-shapes');
    if (shapes.length === 0) {
      container.innerHTML = '<div class="panel-empty">Keine Shapes gefunden.</div>';
      return;
    }
    container.innerHTML = shapes.map(shape => `
      <div class="panel-card" data-id="${shape.id}" data-do="${escHtml(shape.data_object ?? '')}">
        <div class="panel-card-image">
          <img src="/static/images/shapes/${shape.id}.png" alt="${escHtml(shape.name)}" loading="lazy">
        </div>
        <div class="panel-card-body">
          <div class="panel-card-name">${escHtml(shape.name)}</div>
          <div class="panel-card-meta">${escHtml(shape.keywords)}</div>
        </div>
      </div>
    `).join('');

    container.querySelectorAll('.panel-card').forEach(card => {
      card.addEventListener('mousedown', e => {
        if (e.button !== 0) return;
        const shapeId = card.dataset.id;
        const cachedDo = card.dataset.do;
        if (cachedDo) {
          dragDrop(cachedDo);
        } else {
          fetch(`/get_shape/${shapeId}`)
            .then(r => r.text())
            .then(dataObject => {
              card.dataset.do = dataObject;
              dragDrop(dataObject);
            })
            .catch(err => console.error('get_shape failed:', err));
        }
      });
    });
  }

  function dragDrop(dataObject) {
    try {
      const webView = window.chrome && window.chrome.webview && window.chrome.webview.hostObjects;
      if (webView && webView.WebViewDragDrop) {
        webView.WebViewDragDrop.DragDropShape(dataObject);
      }
    } catch (err) {
      console.warn('WebViewDragDrop not available:', err);
    }
  }

  function filterShapes() {
    const search = document.getElementById('search').value.toLowerCase();
    const cat = document.getElementById('category-filter').value.toLowerCase();
    const filtered = allShapes.filter(s => {
      const matchName = s.name.toLowerCase().includes(search) || s.keywords.toLowerCase().includes(search);
      const matchCat = cat ? s.keywords.toLowerCase().includes(cat) : true;
      return matchName && matchCat;
    });
    renderShapes(filtered);
  }

  function populateCategories() {
    const cats = new Set();
    allShapes.forEach(s => {
      s.keywords.split(',').forEach(k => {
        const t = k.trim();
        if (t) cats.add(t);
      });
    });
    const sel = document.getElementById('category-filter');
    cats.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.toLowerCase();
      opt.textContent = c;
      sel.appendChild(opt);
    });
  }

  async function init() {
    try {
      const res = await fetch('/get_shapes?sort=date_desc');
      allShapes = await res.json();
      populateCategories();
      renderShapes(allShapes);
    } catch (err) {
      document.getElementById('panel-shapes').innerHTML =
        '<div class="panel-empty">Shapes konnten nicht geladen werden.</div>';
    }
  }

  document.getElementById('search').addEventListener('input', filterShapes);
  document.getElementById('category-filter').addEventListener('change', filterShapes);

  init();
</script>
{% endblock %}
