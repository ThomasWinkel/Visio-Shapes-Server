{% extends 'base_panel.html' %}
{% block title %}Visio-Shapes Panel{% endblock %}

{% block content %}

<div class="panel-filter">
  <input type="text" id="search" placeholder="Suchen…" autocomplete="off" spellcheck="false">
  <select id="category-filter">
    <option value="">Alle</option>
  </select>
  <button id="view-toggle" class="panel-view-toggle" title="Ansicht wechseln" aria-label="Ansicht wechseln">
    <svg id="icon-detail" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15" fill="currentColor">
      <rect x="0" y="0" width="6" height="15" rx="1"/>
      <rect x="8" y="0" width="7" height="3" rx="1"/>
      <rect x="8" y="5" width="7" height="3" rx="1"/>
      <rect x="8" y="10" width="7" height="3" rx="1"/>
    </svg>
    <svg id="icon-list" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15" fill="currentColor" style="display:none">
      <rect x="0" y="0" width="4" height="4" rx="1"/>
      <rect x="6" y="1" width="9" height="2" rx="1"/>
      <rect x="0" y="6" width="4" height="4" rx="1"/>
      <rect x="6" y="7" width="9" height="2" rx="1"/>
      <rect x="0" y="12" width="4" height="3" rx="1"/>
      <rect x="6" y="13" width="9" height="2" rx="1"/>
    </svg>
  </button>
</div>

<div class="panel-shapes" id="panel-shapes">
  <div class="panel-loading">Shapes werden geladen…</div>
</div>

{% endblock %}

{% block scripts %}
<script>
  let allShapes = [];
  let filteredShapes = [];
  let displayedCount = 0;
  let isLoading = false;
  let debounceTimer;
  let detailView = localStorage.getItem('panel-view') === 'detail';
  const PAGE_SIZE = 20;

  const container = document.getElementById('panel-shapes');
  const searchInput = document.getElementById('search');
  const categoryFilter = document.getElementById('category-filter');

  function escHtml(str) {
    return String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function cardHtml(shape) {
    const doAttr = escHtml(shape.data_object ?? '');
    const img = `<div class="panel-card-image"><img src="/static/images/shapes/${shape.id}.png" alt="${escHtml(shape.name)}" loading="lazy"></div>`;
    if (detailView) {
      return `
        <div class="panel-card detail" data-id="${shape.id}" data-do="${doAttr}">
          ${img}
          <div class="panel-card-body">
            <div class="panel-card-name">${escHtml(shape.name)}</div>
            <div class="panel-card-keywords">${escHtml(shape.keywords)}</div>
            <div class="panel-card-stencil">${escHtml(shape.stencil_title)}</div>
            <div class="panel-card-user">${escHtml(shape.user_name)}</div>
            <div class="panel-card-count">&darr; ${shape.download_count ?? 0}</div>
          </div>
        </div>`;
    } else {
      return `
        <div class="panel-card" data-id="${shape.id}" data-do="${doAttr}">
          ${img}
          <div class="panel-card-body">
            <div class="panel-card-row">
              <div class="panel-card-name">${escHtml(shape.name)}</div>
              <div class="panel-card-user">${escHtml(shape.user_name)}</div>
            </div>
            <div class="panel-card-row">
              <div class="panel-card-keywords">${escHtml(shape.keywords)}</div>
              <div class="panel-card-count">&darr; ${shape.download_count ?? 0}</div>
            </div>
            <div class="panel-card-stencil">${escHtml(shape.stencil_title)}</div>
          </div>
        </div>`;
    }
  }

  function showNextPage() {
    if (isLoading) return;
    const end = Math.min(displayedCount + PAGE_SIZE, filteredShapes.length);
    if (displayedCount >= filteredShapes.length) return;

    isLoading = true;
    const fragment = document.createDocumentFragment();
    for (let i = displayedCount; i < end; i++) {
      const div = document.createElement('div');
      div.innerHTML = cardHtml(filteredShapes[i]).trim();
      fragment.appendChild(div.firstChild);
    }
    container.appendChild(fragment);
    displayedCount = end;
    isLoading = false;
  }

  function filterShapes() {
    const search = searchInput.value.toLowerCase();
    const cat = categoryFilter.value.toLowerCase();

    filteredShapes = allShapes.filter(s => {
      const matchName = s.name.toLowerCase().includes(search) || s.keywords.toLowerCase().includes(search);
      const matchCat = cat ? s.keywords.toLowerCase().includes(cat) : true;
      return matchName && matchCat;
    });

    container.innerHTML = '';
    displayedCount = 0;

    if (filteredShapes.length === 0) {
      container.innerHTML = '<div class="panel-empty">Keine Shapes gefunden.</div>';
      return;
    }
    showNextPage();
  }

  function dragDrop(dataObject) {
    try {
      const webView = window.chrome && window.chrome.webview && window.chrome.webview.hostObjects;
      if (webView && webView.WebViewDragDrop) {
        webView.WebViewDragDrop.DragDropShape(dataObject);
      }
    } catch (err) {
      console.warn('WebViewDragDrop not available:', err);
    }
  }

  // Event Delegation: ein Listener für alle Karten, auch neu geladene
  container.addEventListener('mousedown', e => {
    if (e.button !== 0) return;
    const card = e.target.closest('.panel-card');
    if (!card) return;
    const cachedDo = card.dataset.do;
    if (cachedDo) {
      dragDrop(cachedDo);
    } else {
      fetch(`/get_shape/${card.dataset.id}`)
        .then(r => r.text())
        .then(dataObject => {
          card.dataset.do = dataObject;
          dragDrop(dataObject);
        })
        .catch(err => console.error('get_shape failed:', err));
    }
  });

  function populateCategories() {
    const cats = new Set();
    allShapes.forEach(s => {
      s.keywords.split(',').forEach(k => {
        const t = k.trim();
        if (t) cats.add(t);
      });
    });
    cats.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.toLowerCase();
      opt.textContent = c;
      categoryFilter.appendChild(opt);
    });
  }

  searchInput.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(filterShapes, 350);
  });

  categoryFilter.addEventListener('change', filterShapes);

  window.addEventListener('scroll', () => {
    const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
    if (scrollTop + clientHeight >= scrollHeight - 100 && !isLoading) {
      showNextPage();
    }
  });

  // View toggle
  const toggleBtn = document.getElementById('view-toggle');
  const iconDetail = document.getElementById('icon-detail');
  const iconList = document.getElementById('icon-list');

  function applyView(detail) {
    iconDetail.style.display = detail ? 'none' : '';
    iconList.style.display = detail ? '' : 'none';
  }

  applyView(detailView);

  toggleBtn.addEventListener('click', () => {
    detailView = !detailView;
    localStorage.setItem('panel-view', detailView ? 'detail' : 'list');
    applyView(detailView);
    filterShapes();
  });

  async function init() {
    try {
      const res = await fetch('/get_shapes?sort=date_desc');
      allShapes = await res.json();
      populateCategories();
      filterShapes();
    } catch (err) {
      container.innerHTML = '<div class="panel-empty">Shapes konnten nicht geladen werden.</div>';
    }
  }

  init();
</script>
{% endblock %}
