{% extends 'base_browser.html' %}
{% block title %}{{ _('Visio-Shapes \u2013 Share Microsoft Visio Shapes') }}{% endblock %}

{% block content %}

<section class="hero">
  <div class="container">
    <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Visio-Shapes" class="hero-logo">
    <h1>{{ _('Share Microsoft Visio Shapes worldwide') }}</h1>
    <p>{{ _('Upload your Visio shapes and stencils, share them with the community, and discover shapes from other users.') }}</p>
    <div class="hero-buttons">
      <a href="/browse" class="btn btn-primary">{{ _('Browse shapes') }}</a>
      <a href="https://github.com/ThomasWinkel/Visio-Shapes-Server" class="btn btn-secondary" target="_blank" rel="noopener">GitHub</a>
    </div>
  </div>
</section>

<section class="steps-section">
  <div class="container">
    <h2>{{ _('How does it work?') }}</h2>
    <div class="steps-video">
      <div class="steps-embed" id="yt-facade" data-videoid="2OO1_iuWjoI">
        <button class="yt-play-btn" aria-label="Play video">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="2" width="20" height="20" rx="3" ry="3"/>
            <polygon points="10,8 16,12 10,16" fill="currentColor" stroke="none"/>
          </svg>
        </button>
      </div>
    </div>
    <div class="steps-grid">
      <div class="step-card">
        <div class="step-number">1</div>
        <h3>{{ _('Install VSTO Add-In') }}</h3>
        <p>{{ _('Install the Visio Add-In, which adds a sidebar in Microsoft Visio.') }}</p>
      </div>
      <div class="step-card">
        <div class="step-number">2</div>
        <h3>{{ _('Upload shapes') }}</h3>
        <p>{{ _('Select shapes or a complete stencil in Visio and upload them with one click.') }}</p>
      </div>
      <div class="step-card">
        <div class="step-number">3</div>
        <h3>{{ _('Use shapes') }}</h3>
        <p>{{ _('Search and filter in the sidebar, then drag and drop shapes onto the drawing canvas.') }}</p>
      </div>
    </div>
  </div>
</section>

<section class="latest-section">
  <div class="container">
    <h2>{{ _('Latest Shapes') }}</h2>
    <div class="shapes-grid" id="latest-grid">
      <div class="loading-indicator">{{ _('Loading shapes\u2026') }}</div>
    </div>
  </div>
</section>

<section class="latest-section section-alt">
  <div class="container">
    <h2>{{ _('Top Shapes') }}</h2>
    <div class="shapes-grid" id="top-grid">
      <div class="loading-indicator">{{ _('Loading shapes\u2026') }}</div>
    </div>
    <div class="section-footer">
      <a href="/browse" class="btn btn-ghost">{{ _('View all shapes') }}</a>
    </div>
  </div>
</section>

<section class="business-section">
  <div class="container">
    <h2>{{ _('Business') }}</h2>
    <div class="business-grid">
      <div class="business-card">
        <div class="business-card-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m16 18 6-6-6-6"/>
            <path d="m8 6-6 6 6 6"/>
          </svg>
        </div>
        <div class="business-card-text">
          <h3>{{ _('Free & Open Source') }}</h3>
          <p>{{ _('Visio-Shapes is completely free to use and open source – share, benefit & contribute!') }}</p>
        </div>
      </div>
      <div class="business-card">
        <div class="business-card-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
        </div>
        <div class="business-card-text">
          <h3>{{ _('Private area on request') }}</h3>
          <p>{{ _('Need a private space for your company or your customers? Feel free to get in touch – we are happy to help.') }}</p>
        </div>
        <a href="mailto:info@geradeaus.engineering" class="btn btn-primary btn-icon" aria-label="{{ _('Get in touch') }}">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
            <rect width="20" height="16" x="2" y="4" rx="2"/>
            <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</section>

{% endblock %}

{% block scripts %}
<script>
  function escHtml(str) {
    return String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  const DL_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`;

  function buildCard(shape) {
    const stencilRow = shape.stencil_id
      ? `<div class="shape-card-stencil">
          <span class="shape-card-stencil-name">${escHtml(shape.stencil_file_name)}</span>
          <a href="/download_stencil/${shape.stencil_id}" class="shape-card-dl-btn" title="${window.TRANSLATIONS.download}">${DL_ICON}</a>
        </div>`
      : '';

    return `
      <div class="shape-card">
        <div class="shape-card-image">
          <img src="/static/images/shapes/${shape.id}.png" alt="${escHtml(shape.name)}" loading="lazy">
        </div>
        <div class="shape-card-body">
          <div class="shape-card-name">${escHtml(shape.name)}</div>
          <div class="shape-card-keywords">${escHtml(shape.keywords)}</div>
          ${stencilRow}
        </div>
        <div class="shape-card-footer">
          <span class="shape-card-user">${escHtml(shape.user_name)}</span>
          <span class="shape-card-count">&darr; ${shape.download_count ?? 0}</span>
        </div>
      </div>
    `;
  }

  function renderGrid(gridEl, shapes) {
    gridEl.innerHTML = '';
    if (shapes.length === 0) {
      gridEl.innerHTML = `<div class="empty-state"><p>${window.TRANSLATIONS.no_shapes}</p></div>`;
      return;
    }
    shapes.forEach(shape => gridEl.insertAdjacentHTML('beforeend', buildCard(shape)));
  }

  async function loadSections() {
    const latestGrid = document.getElementById('latest-grid');
    const topGrid    = document.getElementById('top-grid');
    try {
      const [resNewest, resTop] = await Promise.all([
        fetch('/get_shapes?sort=date_desc'),
        fetch('/get_shapes?sort=popular')
      ]);
      const newest = (await resNewest.json()).slice(0, 8);
      const top    = (await resTop.json()).slice(0, 8);
      renderGrid(latestGrid, newest);
      renderGrid(topGrid, top);
    } catch (e) {
      latestGrid.innerHTML = `<div class="empty-state"><p>${window.TRANSLATIONS.load_error}</p></div>`;
      topGrid.innerHTML    = `<div class="empty-state"><p>${window.TRANSLATIONS.load_error}</p></div>`;
    }
  }

  loadSections();

  document.getElementById('yt-facade').addEventListener('click', function () {
    const videoId = this.dataset.videoid;
    const iframe = document.createElement('iframe');
    iframe.src = 'https://www.youtube.com/embed/' + videoId + '?autoplay=1';
    iframe.title = 'Visio-Shapes';
    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
    iframe.allowFullscreen = true;
    this.innerHTML = '';
    this.appendChild(iframe);
  });
</script>
{% endblock %}
