{% extends 'base_browser.html' %}
{% block title %}{{ _('My Account') }} – Visio-Shapes{% endblock %}

{% block content %}
<div class="account-container">

  <div class="account-header">
    <p class="account-meta">
      <span id="account-display-name" class="editable-name" title="{{ _('Click to edit') }}">{{ current_user.name }}</span>
      &middot;
      {% if current_user.pending_email %}
        <span id="account-display-email">{{ current_user.email }}</span>
        <span id="pending-email-hint" class="pending-hint">
          &rarr; <em>{{ current_user.pending_email }}</em> {{ _('(pending confirmation)') }}
          <a href="#" id="cancel-email-change-link">{{ _('Cancel') }}</a>
        </span>
      {% else %}
        <span id="account-display-email" class="editable-name" title="{{ _('Click to edit') }}">{{ current_user.email }}</span>
        <span id="pending-email-hint" class="pending-hint" style="display:none"></span>
      {% endif %}
    </p>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="overview">{{ _('Overview') }}</button>
    <button class="tab-btn" data-tab="shapes">{{ _('My Shapes') }} ({{ shapes|length }})</button>
    <button class="tab-btn" data-tab="stencils">{{ _('My Stencils') }} ({{ stencils|length }})</button>
    <button class="tab-btn" data-tab="teams">{{ _('My Teams') }} ({{ memberships|length }})</button>
  </div>

  <!-- Overview Tab -->
  <div class="tab-panel active" id="tab-overview">

    <p class="overview-meta">{{ _('Member since') }} {{ current_user.register_date | dateformat('medium') }}</p>

    <!-- What I have shared -->
    <div class="overview-section">
      <h3 class="overview-section-title">{{ _('What I have shared') }}</h3>
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-number">{{ shapes|length }}</div>
          <div class="stat-label">{{ _('Shapes shared') }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stencils|length }}</div>
          <div class="stat-label">{{ _('Stencils shared') }}</div>
        </div>
        <div class="stat-card stat-card--accent">
          <div class="stat-number">{{ stats.my_shapes_used_by_others }}</div>
          <div class="stat-label">{{ _('Shape uses by others') }}</div>
        </div>
        <div class="stat-card stat-card--accent">
          <div class="stat-number">{{ stats.my_stencils_downloaded_by_others }}</div>
          <div class="stat-label">{{ _('Stencil downloads by others') }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.users_used_my_shapes }}</div>
          <div class="stat-label">{{ _('Users using my shapes') }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.users_downloaded_my_stencils }}</div>
          <div class="stat-label">{{ _('Users using my stencils') }}</div>
        </div>
      </div>

      {% if stats.top_own_shapes %}
      <div class="overview-subsection">
        <h4 class="overview-subsection-title">{{ _('My most popular shapes') }}</h4>
        <div class="overview-list">
          {% for shape, cnt in stats.top_own_shapes %}
          <div class="overview-list-item">
            <span class="overview-rank">{{ loop.index }}</span>
            <img class="overview-thumb" src="{{ url_for('static', filename='images/shapes/' ~ shape.id ~ '.png') }}" alt="{{ shape.name }}">
            <span class="overview-item-name">{{ shape.name }}</span>
            <span class="overview-item-count">{{ cnt }}&times;</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if stats.top_own_stencils %}
      <div class="overview-subsection">
        <h4 class="overview-subsection-title">{{ _('My most popular stencils') }}</h4>
        <div class="overview-list">
          {% for stencil, cnt in stats.top_own_stencils %}
          <div class="overview-list-item">
            <span class="overview-rank">{{ loop.index }}</span>
            <span class="overview-item-name">{{ stencil.title }}</span>
            <span class="overview-item-count">{{ cnt }}&times;</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Last 30 days -->
    <div class="overview-section">
      <h3 class="overview-section-title">{{ _('Last 30 days') }}</h3>
      <div class="stat-grid">
        <div class="stat-card stat-card--accent">
          <div class="stat-number">{{ stats.my_shapes_used_by_others_30d }}</div>
          <div class="stat-label">{{ _('Shape uses by others') }}</div>
        </div>
        <div class="stat-card stat-card--accent">
          <div class="stat-number">{{ stats.my_stencils_downloaded_by_others_30d }}</div>
          <div class="stat-label">{{ _('Stencil downloads by others') }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.shapes_used_by_me_30d }}</div>
          <div class="stat-label">{{ _('Shapes used by me') }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.stencils_downloaded_by_me_30d }}</div>
          <div class="stat-label">{{ _('Stencils downloaded by me') }}</div>
        </div>
      </div>
    </div>

    <!-- What I have used -->
    <div class="overview-section">
      <h3 class="overview-section-title">{{ _('What I have used') }}</h3>
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-number">{{ stats.shapes_used_total }}</div>
          <div class="stat-label">{{ _('Shapes used') }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.stencils_downloaded_total }}</div>
          <div class="stat-label">{{ _('Stencils downloaded') }}</div>
        </div>
      </div>

      {% if stats.top_used_shapes %}
      <div class="overview-subsection">
        <h4 class="overview-subsection-title">{{ _('Most used shapes') }}</h4>
        <div class="overview-list">
          {% for shape, cnt in stats.top_used_shapes %}
          <div class="overview-list-item">
            <span class="overview-rank">{{ loop.index }}</span>
            <img class="overview-thumb" src="{{ url_for('static', filename='images/shapes/' ~ shape.id ~ '.png') }}" alt="{{ shape.name }}">
            <span class="overview-item-name">{{ shape.name }} <span class="overview-item-author">{% if shape.user_id == current_user.id %}{{ _('by me') }}{% else %}{{ _('by') }} {{ shape.user.name }}{% endif %}</span></span>
            <span class="overview-item-count">{{ cnt }}&times;</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if stats.top_downloaded_stencils %}
      <div class="overview-subsection">
        <h4 class="overview-subsection-title">{{ _('Most downloaded stencils') }}</h4>
        <div class="overview-list">
          {% for stencil, cnt in stats.top_downloaded_stencils %}
          <div class="overview-list-item">
            <span class="overview-rank">{{ loop.index }}</span>
            <span class="overview-item-name">{{ stencil.title }} <span class="overview-item-author">{% if stencil.user_id == current_user.id %}{{ _('by me') }}{% else %}{{ _('by') }} {{ stencil.user.name }}{% endif %}</span></span>
            <span class="overview-item-count">{{ cnt }}&times;</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if not stats.top_used_shapes and not stats.top_downloaded_stencils %}
      <p class="overview-empty">{{ _('No activity yet.') }}</p>
      {% endif %}
    </div>

    <!-- What I have used from others -->
    <div class="overview-section">
      <h3 class="overview-section-title">{{ _('What I have used from others') }}</h3>
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-number">{{ stats.foreign_shapes_used_total }}</div>
          <div class="stat-label">{{ _('Foreign shapes used') }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.foreign_stencils_downloaded_total }}</div>
          <div class="stat-label">{{ _('Foreign stencils downloaded') }}</div>
        </div>
      </div>

      {% if stats.top_foreign_shapes %}
      <div class="overview-subsection">
        <h4 class="overview-subsection-title">{{ _('Most used shapes from others') }}</h4>
        <div class="overview-list">
          {% for shape, cnt in stats.top_foreign_shapes %}
          <div class="overview-list-item">
            <span class="overview-rank">{{ loop.index }}</span>
            <img class="overview-thumb" src="{{ url_for('static', filename='images/shapes/' ~ shape.id ~ '.png') }}" alt="{{ shape.name }}">
            <span class="overview-item-name">{{ shape.name }} <span class="overview-item-author">{{ _('by') }} {{ shape.user.name }}</span></span>
            <span class="overview-item-count">{{ cnt }}&times;</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if stats.top_foreign_stencils %}
      <div class="overview-subsection">
        <h4 class="overview-subsection-title">{{ _('Most downloaded stencils from others') }}</h4>
        <div class="overview-list">
          {% for stencil, cnt in stats.top_foreign_stencils %}
          <div class="overview-list-item">
            <span class="overview-rank">{{ loop.index }}</span>
            <span class="overview-item-name">{{ stencil.title }} <span class="overview-item-author">{{ _('by') }} {{ stencil.user.name }}</span></span>
            <span class="overview-item-count">{{ cnt }}&times;</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if not stats.top_foreign_shapes and not stats.top_foreign_stencils %}
      <p class="overview-empty">{{ _('No activity yet.') }}</p>
      {% endif %}
    </div>

  </div>

  <!-- Shapes Tab -->
  <div class="tab-panel" id="tab-shapes">
    {% if shapes %}
      {% for shape in shapes %}
      <div class="account-item" id="shape-item-{{ shape.id }}">
        <div class="account-item-image">
          <img data-src="{{ url_for('static', filename='images/shapes/' ~ shape.id ~ '.png') }}" alt="{{ shape.name }}">
        </div>
        <div class="account-item-body">
          <div class="account-item-name">{{ shape.name }}</div>
          <div class="account-item-meta">
            {{ _('Keywords:') }} {{ shape.keywords }}<br>
            {{ _('Uploaded:') }} {{ shape.upload_date | dateformat('medium') }}
            {% if shape.stencil %} &middot; {{ _('Part of stencil:') }} {{ shape.stencil.title }}{% endif %}
            {% if shape.team %} &middot; Team: <strong>{{ shape.team.name }}</strong>{% endif %}
          </div>
          <div class="account-item-actions">
            <button class="btn btn-secondary btn-sm" onclick="toggleEdit('shape', {{ shape.id }})">{{ _('Edit') }}</button>
            <button class="btn btn-danger btn-sm" onclick="confirmDelete('shape', {{ shape.id }}, '{{ shape.name|e }}')">{{ _('Delete') }}</button>
          </div>
          <div class="edit-form" id="edit-shape-{{ shape.id }}">
            <form onsubmit="submitEdit(event, 'shape', {{ shape.id }})">
              <div class="form-group">
                <label>{{ _('Name') }}</label>
                <input type="text" class="form-control" name="name" value="{{ shape.name|e }}" required>
              </div>
              <div class="form-group">
                <label>{{ _('Keywords') }}</label>
                <input type="text" class="form-control" name="keywords" value="{{ shape.keywords|e }}">
              </div>
              <div class="form-group">
                <label>{{ _('Prompt') }}</label>
                <input type="text" class="form-control" name="prompt" value="{{ shape.prompt|e }}">
              </div>
              <div class="edit-form-actions">
                <button type="submit" class="btn btn-primary btn-sm">{{ _('Save') }}</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEdit('shape', {{ shape.id }})">{{ _('Cancel') }}</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="empty-state"><p>{{ _('No shapes uploaded yet.') }}</p></div>
    {% endif %}
  </div>

  <!-- Stencils Tab -->
  <div class="tab-panel" id="tab-stencils">
    {% if stencils %}
      {% for stencil in stencils %}
      <div class="account-item" id="stencil-item-{{ stencil.id }}">
        <div class="account-item-body">
          <div class="account-item-name">{{ stencil.title }}</div>
          <div class="account-item-meta">
            {{ _('File:') }} {{ stencil.file_name }} &middot;
            {{ _('Shapes:') }} {{ stencil.shapes|length }} &middot;
            {{ _('Uploaded:') }} {{ stencil.upload_date | dateformat('medium') }}
            {% if stencil.categories %} &middot; {{ _('Categories:') }} {{ stencil.categories }}{% endif %}
            {% if stencil.team %} &middot; Team: <strong>{{ stencil.team.name }}</strong>{% endif %}
          </div>
          <div class="account-item-actions">
            <button class="btn btn-secondary btn-sm" onclick="toggleEdit('stencil', {{ stencil.id }})">{{ _('Edit') }}</button>
            <button class="btn btn-danger btn-sm" onclick="confirmDelete('stencil', {{ stencil.id }}, '{{ stencil.title|e }}')">{{ _('Delete') }}</button>
          </div>
          <div class="edit-form" id="edit-stencil-{{ stencil.id }}">
            <form onsubmit="submitEdit(event, 'stencil', {{ stencil.id }})">
              <div class="form-group">
                <label>{{ _('Title') }}</label>
                <input type="text" class="form-control" name="title" value="{{ stencil.title|e }}" required>
              </div>
              <div class="form-group">
                <label>{{ _('Categories') }}</label>
                <input type="text" class="form-control" name="categories" value="{{ stencil.categories|e }}">
              </div>
              <div class="form-group">
                <label>{{ _('Tags') }}</label>
                <input type="text" class="form-control" name="tags" value="{{ stencil.tags|e }}">
              </div>
              <div class="form-group">
                <label>{{ _('Comment') }}</label>
                <input type="text" class="form-control" name="comments" value="{{ stencil.comments|e }}">
              </div>
              <div class="edit-form-actions">
                <button type="submit" class="btn btn-primary btn-sm">{{ _('Save') }}</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEdit('stencil', {{ stencil.id }})">{{ _('Cancel') }}</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="empty-state"><p>{{ _('No stencils uploaded yet.') }}</p></div>
    {% endif %}
  </div>

  <!-- My Teams Tab -->
  <div class="tab-panel" id="tab-teams">
    {% if memberships %}
      {% for m in memberships %}
      <div class="team-card" id="team-card-{{ m.team.id }}">
        <div class="team-card-header">
          <div class="team-card-title">{{ m.team.name }}</div>
          <div class="team-card-badges">
            <span class="team-visibility-badge team-visibility-{{ m.team.visibility }}" id="visibility-badge-{{ m.team.id }}">{{ m.team.visibility | capitalize }}</span>
            {% if m.role == 'owner' %}
              <span class="team-role-badge team-role-owner">Owner</span>
            {% elif m.role == 'admin' %}
              <span class="team-role-badge team-role-admin">Admin</span>
            {% elif m.role == 'contributor' %}
              <span class="team-role-badge team-role-contributor">Contributor</span>
            {% else %}
              <span class="team-role-badge">{{ _('Member') }}</span>
            {% endif %}
          </div>
        </div>

        {% if m.team.description %}
        <p class="team-card-description">{{ m.team.description }}</p>
        {% endif %}

        <p class="team-card-meta">{{ m.team.memberships|length }} {{ _('members') }}</p>

        {% if m.role == 'owner' %}
        <!-- Team Owner: Visibility -->
        <div class="team-visibility-row">
          <label class="team-visibility-label">{{ _('Visibility') }}</label>
          <select class="form-control form-control-sm team-visibility-select"
                  id="visibility-select-{{ m.team.id }}"
                  data-current="{{ m.team.visibility }}"
                  onchange="confirmVisibilityChange({{ m.team.id }}, this)">
            <option value="public"  {% if m.team.visibility == 'public'  %}selected{% endif %}>{{ _('Public') }}</option>
            <option value="visible" {% if m.team.visibility == 'visible' %}selected{% endif %}>{{ _('Visible') }}</option>
            <option value="private" {% if m.team.visibility == 'private' %}selected{% endif %}>{{ _('Private') }}</option>
          </select>
        </div>

        <!-- Team Owner: Member management -->
        <div class="team-members-section">
          <h4 class="team-members-title">{{ _('Members') }}</h4>
          <div class="team-member-list" id="member-list-{{ m.team.id }}">
            {% for member_m in m.team.memberships %}
            <div class="team-member-item" id="member-{{ m.team.id }}-{{ member_m.user.id }}">
              <div class="team-member-info">
                <span class="team-member-name">{{ member_m.user.name }}</span>
                <span class="team-member-email">{{ member_m.user.email }}</span>
              </div>
              {% if member_m.role == 'owner' %}
                <span class="team-role-badge team-role-owner">Owner</span>
              {% else %}
                <select class="form-control form-control-sm team-role-select"
                        onchange="setMemberRole({{ m.team.id }}, {{ member_m.user.id }}, this.value, this)">
                  <option value=""            {% if not member_m.role %}selected{% endif %}>{{ _('Member') }}</option>
                  <option value="contributor" {% if member_m.role == 'contributor' %}selected{% endif %}>Contributor</option>
                  <option value="admin"       {% if member_m.role == 'admin' %}selected{% endif %}>Admin</option>
                </select>
                <button class="btn btn-danger btn-sm"
                        onclick="removeMember({{ m.team.id }}, {{ member_m.user.id }}, '{{ member_m.user.name|e }}')">{{ _('Remove') }}</button>
              {% endif %}
            </div>
            {% endfor %}
          </div>

          <!-- Add member -->
          <div class="add-member-form">
            <h4 class="team-members-title">{{ _('Add member') }}</h4>
            <div class="add-member-row">
              <input type="email" class="form-control" id="add-email-{{ m.team.id }}"
                     placeholder="{{ _('Email address') }}">
              <select class="form-control" id="add-role-{{ m.team.id }}">
                <option value="">{{ _('Member') }}</option>
                <option value="contributor">Contributor</option>
                <option value="admin">Admin</option>
              </select>
              <button class="btn btn-primary" onclick="addMember({{ m.team.id }})">{{ _('Add') }}</button>
            </div>
            <div class="form-error" id="add-error-{{ m.team.id }}"></div>
          </div>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    {% else %}
      <div class="empty-state"><p>{{ _('You are not a member of any team.') }}</p></div>
    {% endif %}
  </div>

</div>

<!-- Delete confirmation dialog -->
<dialog id="delete-dialog">
  <h3>{{ _('Confirm deletion') }}</h3>
  <p id="delete-dialog-text"></p>
  <div class="dialog-actions">
    <button class="btn btn-secondary" onclick="document.getElementById('delete-dialog').close()">{{ _('Cancel') }}</button>
    <button class="btn btn-danger" id="delete-confirm-btn">{{ _('Delete') }}</button>
  </div>
</dialog>

<!-- Visibility change confirmation dialog -->
<dialog id="visibility-dialog">
  <h3>{{ _('Change visibility') }}</h3>
  <p id="visibility-dialog-text"></p>
  <div class="dialog-actions">
    <button class="btn btn-secondary" id="visibility-cancel-btn">{{ _('Cancel') }}</button>
    <button class="btn btn-primary" id="visibility-confirm-btn">{{ _('Change') }}</button>
  </div>
</dialog>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/account.js') }}"></script>
<script>
// ── Team visibility ──

let _pendingVisibility = null;

function confirmVisibilityChange(teamId, selectEl) {
  const newValue  = selectEl.value;
  const prevValue = selectEl.dataset.current;
  if (newValue === prevValue) return;
  _pendingVisibility = { teamId, newValue, prevValue, selectEl };
  document.getElementById('visibility-dialog-text').textContent =
    window.TRANSLATIONS.visibility_change_confirm.replace('{value}', newValue);
  document.getElementById('visibility-dialog').showModal();
}

document.getElementById('visibility-cancel-btn').addEventListener('click', () => {
  document.getElementById('visibility-dialog').close();
  if (_pendingVisibility) {
    _pendingVisibility.selectEl.value = _pendingVisibility.prevValue;
    _pendingVisibility = null;
  }
});

document.getElementById('visibility-confirm-btn').addEventListener('click', async () => {
  document.getElementById('visibility-dialog').close();
  if (!_pendingVisibility) return;
  const { teamId, newValue, prevValue, selectEl } = _pendingVisibility;
  _pendingVisibility = null;

  const fd = new FormData();
  fd.append('visibility', newValue);
  try {
    const res = await fetch(`/account/team/${teamId}/set_visibility`, { method: 'POST', body: fd });
    if (res.ok) {
      selectEl.dataset.current = newValue;
      const badgeEl = document.getElementById(`visibility-badge-${teamId}`);
      if (badgeEl) {
        badgeEl.className = `team-visibility-badge team-visibility-${newValue}`;
        badgeEl.textContent = newValue.charAt(0).toUpperCase() + newValue.slice(1);
      }
    } else {
      alert(window.TRANSLATIONS.save_error);
      selectEl.value = prevValue;
    }
  } catch {
    alert(window.TRANSLATIONS.network_error);
    selectEl.value = prevValue;
  }
});

// ── Team member management ──

async function addMember(teamId) {
  const emailInput = document.getElementById(`add-email-${teamId}`);
  const roleSelect = document.getElementById(`add-role-${teamId}`);
  const errorEl   = document.getElementById(`add-error-${teamId}`);
  errorEl.textContent = '';

  const fd = new FormData();
  fd.append('email', emailInput.value.trim());
  if (roleSelect.value) fd.append('role', roleSelect.value);

  try {
    const res  = await fetch(`/account/team/${teamId}/add_member`, { method: 'POST', body: fd });
    const data = await res.json();
    if (!res.ok) {
      if (data.error === 'user_not_found')  errorEl.textContent = window.TRANSLATIONS.user_not_found;
      else if (data.error === 'already_member') errorEl.textContent = window.TRANSLATIONS.already_member;
      else errorEl.textContent = window.TRANSLATIONS.save_error;
      return;
    }
    // Reload to show updated member list
    location.reload();
  } catch {
    errorEl.textContent = window.TRANSLATIONS.network_error;
  }
}

async function removeMember(teamId, userId, name) {
  if (!confirm(window.TRANSLATIONS.delete_confirm.replace('{name}', name))) return;
  const fd = new FormData();
  fd.append('user_id', userId);
  try {
    const res = await fetch(`/account/team/${teamId}/remove_member`, { method: 'POST', body: fd });
    if (res.ok) {
      document.getElementById(`member-${teamId}-${userId}`)?.remove();
    } else {
      alert(window.TRANSLATIONS.delete_error);
    }
  } catch {
    alert(window.TRANSLATIONS.network_error);
  }
}

async function setMemberRole(teamId, userId, role, selectEl) {
  const fd = new FormData();
  fd.append('user_id', userId);
  fd.append('role', role);
  try {
    const res = await fetch(`/account/team/${teamId}/set_member_role`, { method: 'POST', body: fd });
    if (!res.ok) {
      alert(window.TRANSLATIONS.save_error);
      // Reset select to previous value on error
      location.reload();
    }
  } catch {
    alert(window.TRANSLATIONS.network_error);
    location.reload();
  }
}
</script>
{% endblock %}
