{% extends 'base_browser.html' %}
{% block title %}{{ _('My Account') }} â€“ Visio-Shapes{% endblock %}

{% block content %}
<div class="account-container">

  <div class="account-header">
    <h1>{{ _('My Account') }}</h1>
    <p class="account-meta">
      <span id="account-display-name" class="editable-name" title="{{ _('Click to edit') }}">{{ current_user.name }}</span>
      &middot;
      {% if current_user.pending_email %}
        <span id="account-display-email">{{ current_user.email }}</span>
        <span id="pending-email-hint" class="pending-hint">
          &rarr; <em>{{ current_user.pending_email }}</em> {{ _('(pending confirmation)') }}
          <a href="#" id="cancel-email-change-link">{{ _('Cancel') }}</a>
        </span>
      {% else %}
        <span id="account-display-email" class="editable-name" title="{{ _('Click to edit') }}">{{ current_user.email }}</span>
        <span id="pending-email-hint" class="pending-hint" style="display:none"></span>
      {% endif %}
    </p>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="overview">{{ _('Overview') }}</button>
    <button class="tab-btn" data-tab="shapes">{{ _('My Shapes') }} ({{ shapes|length }})</button>
    <button class="tab-btn" data-tab="stencils">{{ _('My Stencils') }} ({{ stencils|length }})</button>
  </div>

  <!-- Overview Tab -->
  <div class="tab-panel active" id="tab-overview">

    <p class="overview-meta">{{ _('Member since') }} {{ current_user.register_date | dateformat('medium') }}</p>

    <!-- What I have shared -->
    <div class="overview-section">
      <h3 class="overview-section-title">{{ _('What I have shared') }}</h3>
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-number">{{ shapes|length }}</div>
          <div class="stat-label">{{ _('Shapes shared') }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stencils|length }}</div>
          <div class="stat-label">{{ _('Stencils shared') }}</div>
        </div>
        <div class="stat-card stat-card--accent">
          <div class="stat-number">{{ stats.my_shapes_used_by_others }}</div>
          <div class="stat-label">{{ _('Shape uses by others') }}</div>
        </div>
        <div class="stat-card stat-card--accent">
          <div class="stat-number">{{ stats.my_stencils_downloaded_by_others }}</div>
          <div class="stat-label">{{ _('Stencil downloads by others') }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.users_used_my_shapes }}</div>
          <div class="stat-label">{{ _('Users using my shapes') }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.users_downloaded_my_stencils }}</div>
          <div class="stat-label">{{ _('Users using my stencils') }}</div>
        </div>
      </div>

      {% if stats.top_own_shapes %}
      <div class="overview-subsection">
        <h4 class="overview-subsection-title">{{ _('My most popular shapes') }}</h4>
        <div class="overview-list">
          {% for shape, cnt in stats.top_own_shapes %}
          <div class="overview-list-item">
            <span class="overview-rank">{{ loop.index }}</span>
            <img class="overview-thumb" src="{{ url_for('static', filename='images/shapes/' ~ shape.id ~ '.png') }}" alt="{{ shape.name }}">
            <span class="overview-item-name">{{ shape.name }}</span>
            <span class="overview-item-count">{{ cnt }}&times;</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if stats.top_own_stencils %}
      <div class="overview-subsection">
        <h4 class="overview-subsection-title">{{ _('My most popular stencils') }}</h4>
        <div class="overview-list">
          {% for stencil, cnt in stats.top_own_stencils %}
          <div class="overview-list-item">
            <span class="overview-rank">{{ loop.index }}</span>
            <span class="overview-item-name">{{ stencil.title }}</span>
            <span class="overview-item-count">{{ cnt }}&times;</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Last 30 days -->
    <div class="overview-section">
      <h3 class="overview-section-title">{{ _('Last 30 days') }}</h3>
      <div class="stat-grid">
        <div class="stat-card stat-card--accent">
          <div class="stat-number">{{ stats.my_shapes_used_by_others_30d }}</div>
          <div class="stat-label">{{ _('Shape uses by others') }}</div>
        </div>
        <div class="stat-card stat-card--accent">
          <div class="stat-number">{{ stats.my_stencils_downloaded_by_others_30d }}</div>
          <div class="stat-label">{{ _('Stencil downloads by others') }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.shapes_used_by_me_30d }}</div>
          <div class="stat-label">{{ _('Shapes used by me') }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.stencils_downloaded_by_me_30d }}</div>
          <div class="stat-label">{{ _('Stencils downloaded by me') }}</div>
        </div>
      </div>
    </div>

    <!-- What I have used -->
    <div class="overview-section">
      <h3 class="overview-section-title">{{ _('What I have used') }}</h3>
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-number">{{ stats.shapes_used_total }}</div>
          <div class="stat-label">{{ _('Shapes used') }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.stencils_downloaded_total }}</div>
          <div class="stat-label">{{ _('Stencils downloaded') }}</div>
        </div>
      </div>

      {% if stats.top_used_shapes %}
      <div class="overview-subsection">
        <h4 class="overview-subsection-title">{{ _('Most used shapes') }}</h4>
        <div class="overview-list">
          {% for shape, cnt in stats.top_used_shapes %}
          <div class="overview-list-item">
            <span class="overview-rank">{{ loop.index }}</span>
            <img class="overview-thumb" src="{{ url_for('static', filename='images/shapes/' ~ shape.id ~ '.png') }}" alt="{{ shape.name }}">
            <span class="overview-item-name">{{ shape.name }} <span class="overview-item-author">{% if shape.user_id == current_user.id %}{{ _('by me') }}{% else %}{{ _('by') }} {{ shape.user.name }}{% endif %}</span></span>
            <span class="overview-item-count">{{ cnt }}&times;</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if stats.top_downloaded_stencils %}
      <div class="overview-subsection">
        <h4 class="overview-subsection-title">{{ _('Most downloaded stencils') }}</h4>
        <div class="overview-list">
          {% for stencil, cnt in stats.top_downloaded_stencils %}
          <div class="overview-list-item">
            <span class="overview-rank">{{ loop.index }}</span>
            <span class="overview-item-name">{{ stencil.title }} <span class="overview-item-author">{% if stencil.user_id == current_user.id %}{{ _('by me') }}{% else %}{{ _('by') }} {{ stencil.user.name }}{% endif %}</span></span>
            <span class="overview-item-count">{{ cnt }}&times;</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if not stats.top_used_shapes and not stats.top_downloaded_stencils %}
      <p class="overview-empty">{{ _('No activity yet.') }}</p>
      {% endif %}
    </div>

    <!-- What I have used from others -->
    <div class="overview-section">
      <h3 class="overview-section-title">{{ _('What I have used from others') }}</h3>
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-number">{{ stats.foreign_shapes_used_total }}</div>
          <div class="stat-label">{{ _('Foreign shapes used') }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ stats.foreign_stencils_downloaded_total }}</div>
          <div class="stat-label">{{ _('Foreign stencils downloaded') }}</div>
        </div>
      </div>

      {% if stats.top_foreign_shapes %}
      <div class="overview-subsection">
        <h4 class="overview-subsection-title">{{ _('Most used shapes from others') }}</h4>
        <div class="overview-list">
          {% for shape, cnt in stats.top_foreign_shapes %}
          <div class="overview-list-item">
            <span class="overview-rank">{{ loop.index }}</span>
            <img class="overview-thumb" src="{{ url_for('static', filename='images/shapes/' ~ shape.id ~ '.png') }}" alt="{{ shape.name }}">
            <span class="overview-item-name">{{ shape.name }} <span class="overview-item-author">{{ _('by') }} {{ shape.user.name }}</span></span>
            <span class="overview-item-count">{{ cnt }}&times;</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if stats.top_foreign_stencils %}
      <div class="overview-subsection">
        <h4 class="overview-subsection-title">{{ _('Most downloaded stencils from others') }}</h4>
        <div class="overview-list">
          {% for stencil, cnt in stats.top_foreign_stencils %}
          <div class="overview-list-item">
            <span class="overview-rank">{{ loop.index }}</span>
            <span class="overview-item-name">{{ stencil.title }} <span class="overview-item-author">{{ _('by') }} {{ stencil.user.name }}</span></span>
            <span class="overview-item-count">{{ cnt }}&times;</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if not stats.top_foreign_shapes and not stats.top_foreign_stencils %}
      <p class="overview-empty">{{ _('No activity yet.') }}</p>
      {% endif %}
    </div>

  </div>

  <!-- Shapes Tab -->
  <div class="tab-panel" id="tab-shapes">
    {% if shapes %}
      {% for shape in shapes %}
      <div class="account-item" id="shape-item-{{ shape.id }}">
        <div class="account-item-image">
          <img data-src="{{ url_for('static', filename='images/shapes/' ~ shape.id ~ '.png') }}" alt="{{ shape.name }}">
        </div>
        <div class="account-item-body">
          <div class="account-item-name">{{ shape.name }}</div>
          <div class="account-item-meta">
            {{ _('Keywords:') }} {{ shape.keywords }}<br>
            {{ _('Uploaded:') }} {{ shape.upload_date | dateformat('medium') }}
            {% if shape.stencil %} &middot; {{ _('Part of stencil:') }} {{ shape.stencil.title }}{% endif %}
          </div>
          <div class="account-item-actions">
            <button class="btn btn-secondary btn-sm" onclick="toggleEdit('shape', {{ shape.id }})">{{ _('Edit') }}</button>
            <button class="btn btn-danger btn-sm" onclick="confirmDelete('shape', {{ shape.id }}, '{{ shape.name|e }}')">{{ _('Delete') }}</button>
          </div>
          <div class="edit-form" id="edit-shape-{{ shape.id }}">
            <form onsubmit="submitEdit(event, 'shape', {{ shape.id }})">
              <div class="form-group">
                <label>{{ _('Name') }}</label>
                <input type="text" class="form-control" name="name" value="{{ shape.name|e }}" required>
              </div>
              <div class="form-group">
                <label>{{ _('Keywords') }}</label>
                <input type="text" class="form-control" name="keywords" value="{{ shape.keywords|e }}">
              </div>
              <div class="form-group">
                <label>{{ _('Prompt') }}</label>
                <input type="text" class="form-control" name="prompt" value="{{ shape.prompt|e }}">
              </div>
              <div class="edit-form-actions">
                <button type="submit" class="btn btn-primary btn-sm">{{ _('Save') }}</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEdit('shape', {{ shape.id }})">{{ _('Cancel') }}</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="empty-state"><p>{{ _('No shapes uploaded yet.') }}</p></div>
    {% endif %}
  </div>

  <!-- Stencils Tab -->
  <div class="tab-panel" id="tab-stencils">
    {% if stencils %}
      {% for stencil in stencils %}
      <div class="account-item" id="stencil-item-{{ stencil.id }}">
        <div class="account-item-body">
          <div class="account-item-name">{{ stencil.title }}</div>
          <div class="account-item-meta">
            {{ _('File:') }} {{ stencil.file_name }} &middot;
            {{ _('Shapes:') }} {{ stencil.shapes|length }} &middot;
            {{ _('Uploaded:') }} {{ stencil.upload_date | dateformat('medium') }}
            {% if stencil.categories %} &middot; {{ _('Categories:') }} {{ stencil.categories }}{% endif %}
          </div>
          <div class="account-item-actions">
            <button class="btn btn-secondary btn-sm" onclick="toggleEdit('stencil', {{ stencil.id }})">{{ _('Edit') }}</button>
            <button class="btn btn-danger btn-sm" onclick="confirmDelete('stencil', {{ stencil.id }}, '{{ stencil.title|e }}')">{{ _('Delete') }}</button>
          </div>
          <div class="edit-form" id="edit-stencil-{{ stencil.id }}">
            <form onsubmit="submitEdit(event, 'stencil', {{ stencil.id }})">
              <div class="form-group">
                <label>{{ _('Title') }}</label>
                <input type="text" class="form-control" name="title" value="{{ stencil.title|e }}" required>
              </div>
              <div class="form-group">
                <label>{{ _('Categories') }}</label>
                <input type="text" class="form-control" name="categories" value="{{ stencil.categories|e }}">
              </div>
              <div class="form-group">
                <label>{{ _('Tags') }}</label>
                <input type="text" class="form-control" name="tags" value="{{ stencil.tags|e }}">
              </div>
              <div class="form-group">
                <label>{{ _('Comment') }}</label>
                <input type="text" class="form-control" name="comments" value="{{ stencil.comments|e }}">
              </div>
              <div class="edit-form-actions">
                <button type="submit" class="btn btn-primary btn-sm">{{ _('Save') }}</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEdit('stencil', {{ stencil.id }})">{{ _('Cancel') }}</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="empty-state"><p>{{ _('No stencils uploaded yet.') }}</p></div>
    {% endif %}
  </div>

</div>

<!-- Delete confirmation dialog -->
<dialog id="delete-dialog">
  <h3>{{ _('Confirm deletion') }}</h3>
  <p id="delete-dialog-text"></p>
  <div class="dialog-actions">
    <button class="btn btn-secondary" onclick="document.getElementById('delete-dialog').close()">{{ _('Cancel') }}</button>
    <button class="btn btn-danger" id="delete-confirm-btn">{{ _('Delete') }}</button>
  </div>
</dialog>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/account.js') }}"></script>
{% endblock %}
